<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAPNCom - منصة التطبيقات والألعاب الآمنة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4cc9f0;
            --danger: #e63946;
            --warning: #ffbe0b;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 16px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
            --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: var(--gradient);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>');
            background-size: cover;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* Card Styles */
        .card {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .card h2, .card h3 {
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h2 i, .card h3 i {
            color: var(--secondary);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
            background-color: #f9f9f9;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background-color: white;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #5a08a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(67, 97, 238, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #5a08a1 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a08a1 0%, #4a077e 100%);
            transform: translateY(-2px);
            box-shadow: 0 7px 15px rgba(114, 9, 183, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #3a86ff 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c1121f 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-full {
            width: 100%;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Role Selection */
        .role-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .role-card {
            border: 3px solid #ddd;
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .role-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .role-card.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .role-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .role-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .role-description {
            color: var(--gray);
            font-size: 0.95rem;
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 30px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-right: 50px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        /* Apps Grid */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .app-card {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .app-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .app-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }

        .app-info {
            padding: 20px;
        }

        .app-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .app-developer {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .app-description {
            color: var(--gray);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .app-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* App Details */
        .app-details {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .app-hero {
            position: relative;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .app-hero-content {
            text-align: center;
            z-index: 2;
        }

        .app-hero-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .app-hero-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .app-hero-developer {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .app-content {
            padding: 40px;
        }

        .app-screenshots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .screenshot {
            width: 100%;
            height: 150px;
            background: var(--light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-size: 2rem;
        }

        .download-section {
            background: var(--light);
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-top: 30px;
        }

        .download-btn {
            font-size: 1.2rem;
            padding: 15px 40px;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .image-upload:hover {
            border-color: var(--primary);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
        }

        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress {
            height: 100%;
            background: var(--gradient);
            border-radius: 5px;
            transition: width 0.4s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }

        /* Alert Styles */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .alert-success {
            background-color: rgba(76, 201, 240, 0.15);
            color: #0a9396;
            border: 1px solid rgba(76, 201, 240, 0.3);
        }

        .alert-danger {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            border: 1px solid rgba(230, 57, 70, 0.2);
        }

        .alert-info {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border: 1px solid rgba(67, 97, 238, 0.2);
        }

        /* Navigation */
        .nav-bar {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-radius: var(--border-radius);
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Hidden Sections */
        #welcomeScreen, #userRoleSelection, #developerAuth, #userAuth, #developerDashboard, #userDashboard, #appDetails {
            display: none;
        }

        #welcomeScreen {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .role-selection {
                grid-template-columns: 1fr;
            }
            
            .apps-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .app-hero-name {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

<!-- الشاشة الرئيسية -->
<div id="welcomeScreen">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-rocket"></i> CAPNCom</h1>
            <p>منصة التطبيقات والألعاب الآمنة - انضم إلى مجتمعنا المتنامي</p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-door-open"></i> مرحباً بك في CAPNCom</h2>
            <p style="text-align: center; margin-bottom: 30px; color: var(--gray);">
                اختر نوع الحساب المناسب لك للبدء
            </p>
            
            <div class="role-selection">
                <div class="role-card" onclick="selectRole('developer')">
                    <div class="role-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="role-title">مطور</div>
                    <div class="role-description">
                        انشر تطبيقاتك وألعابك وشاركها مع العالم
                    </div>
                </div>
                
                <div class="role-card" onclick="selectRole('user')">
                    <div class="role-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="role-title">مستخدم</div>
                    <div class="role-description">
                        استكشف وتحميل أفضل التطبيقات والألعاب
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- اختيار دور المطور -->
<div id="developerAuth">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-code"></i> المطورين</h1>
            <p>انشر تطبيقاتك ووصلها إلى الملايين</p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-user-tie"></i> حساب المطور</h2>
            
            <button id="googleDeveloperLogin" class="btn btn-secondary btn-full">
                <i class="fab fa-google"></i> تسجيل دخول كمطور باستخدام جوجل
            </button>
            
            <div class="divider">
                <span>أو</span>
            </div>
            
            <div class="form-group">
                <label for="devName"><i class="fas fa-user"></i> اسم المطور</label>
                <input type="text" id="devName" placeholder="أدخل اسمك كمطور">
            </div>
            
            <div class="form-group">
                <label for="devEmail"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                <input type="email" id="devEmail" placeholder="أدخل بريدك الإلكتروني">
            </div>
            
            <div class="form-group">
                <label for="devPassword"><i class="fas fa-lock"></i> كلمة المرور</label>
                <input type="password" id="devPassword" placeholder="أنشئ كلمة مرور قوية">
            </div>
            
            <button id="devRegisterBtn" class="btn btn-primary btn-full">
                <i class="fas fa-user-plus"></i> إنشاء حساب مطور
            </button>
            
            <div class="auth-switch">
                <p>لديك حساب مطور؟ <a onclick="showDeveloperLogin()">تسجيل الدخول</a></p>
            </div>
            
            <div id="devAuthMsg" class="alert alert-danger" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- اختيار دور المستخدم -->
<div id="userAuth">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-user"></i> المستخدمين</h1>
            <p>اكتشف عالم التطبيقات والألعاب المذهل</p>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-user-circle"></i> حساب المستخدم</h2>
            
            <button id="googleUserLogin" class="btn btn-secondary btn-full">
                <i class="fab fa-google"></i> تسجيل دخول كمستخدم باستخدام جوجل
            </button>
            
            <div class="divider">
                <span>أو</span>
            </div>
            
            <div class="form-group">
                <label for="userName"><i class="fas fa-user"></i> اسم المستخدم</label>
                <input type="text" id="userName" placeholder="أدخل اسمك">
            </div>
            
            <div class="form-group">
                <label for="userEmail"><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                <input type="email" id="userEmail" placeholder="أدخل بريدك الإلكتروني">
            </div>
            
            <div class="form-group">
                <label for="userPassword"><i class="fas fa-lock"></i> كلمة المرور</label>
                <input type="password" id="userPassword" placeholder="أنشئ كلمة مرور">
            </div>
            
            <button id="userRegisterBtn" class="btn btn-primary btn-full">
                <i class="fas fa-user-plus"></i> إنشاء حساب مستخدم
            </button>
            
            <div class="auth-switch">
                <p>لديك حساب مستخدم؟ <a onclick="showUserLogin()">تسجيل الدخول</a></p>
            </div>
            
            <div id="userAuthMsg" class="alert alert-danger" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- لوحة تحكم المطور -->
<div id="developerDashboard">
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="nav-logo">CAPNCom - المطور</div>
            <div class="nav-user">
                <div class="user-avatar" id="devAvatar">M</div>
                <button class="btn btn-outline btn-small" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="card">
            <h2><i class="fas fa-plus-circle"></i> إضافة تطبيق جديد</h2>
            
            <div class="form-group">
                <label for="appName"><i class="fas fa-cube"></i> اسم التطبيق</label>
                <input type="text" id="appName" placeholder="أدخل اسم التطبيق">
            </div>
            
            <div class="form-group">
                <label for="appDescription"><i class="fas fa-align-left"></i> وصف التطبيق</label>
                <textarea id="appDescription" placeholder="أدخل وصفاً مفصلاً للتطبيق..." rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-images"></i> صور التطبيق</label>
                <div class="image-upload" onclick="document.getElementById('appImages').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p>انقر لرفع صور التطبيق</p>
                    <small>يمكنك رفع multiple صور</small>
                    <input type="file" id="appImages" multiple accept="image/*" style="display: none;">
                </div>
                <div class="image-preview" id="imagePreview"></div>
            </div>
            
            <div class="form-group">
                <label for="appFile"><i class="fas fa-file"></i> ملف التطبيق</label>
                <input type="file" id="appFile" accept=".apk,.ipa,.exe,.dmg,.zip">
            </div>
            
            <button id="publishAppBtn" class="btn btn-primary btn-full">
                <i class="fas fa-paper-plane"></i> نشر التطبيق
            </button>
            
            <div class="progress-container" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
            
            <div id="uploadMsg" class="alert alert-success" style="display: none;"></div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-list"></i> تطبيقاتي</h3>
            <div id="developerAppsList">
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3>لا توجد تطبيقات منشورة بعد</h3>
                    <p>ابدأ بنشر أول تطبيق لك</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- لوحة تحكم المستخدم -->
<div id="userDashboard">
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="nav-logo">CAPNCom - المتجر</div>
            <div class="nav-user">
                <div class="user-avatar" id="userAvatar">U</div>
                <button class="btn btn-outline btn-small" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ابحث عن تطبيقات أو ألعاب...">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-mobile-alt"></i> التطبيقات والألعاب</h2>
            <div id="appsGrid" class="apps-grid">
                <!-- سيتم تحميل التطبيقات هنا -->
            </div>
        </div>
    </div>
</div>

<!-- تفاصيل التطبيق -->
<div id="appDetails">
    <nav class="nav-bar">
        <div class="nav-content">
            <div class="nav-logo">CAPNCom</div>
            <button class="btn btn-outline btn-small" onclick="goBack()">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
        </div>
    </nav>
    
    <div class="container">
        <div id="appDetailsContent">
            <!-- سيتم تحميل تفاصيل التطبيق هنا -->
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider, 
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    updateProfile
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { 
    getStorage, 
    ref, 
    uploadBytesResumable, 
    getDownloadURL, 
    deleteObject 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    deleteDoc, 
    doc,
    query,
    where,
    updateDoc,
    orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBCJETdj6xlMQ07_GogGU7YkrxivUCaLF8",
    authDomain: "ggni-cec3b.firebaseapp.com",
    projectId: "ggni-cec3b",
    storageBucket: "ggni-cec3b.appspot.com",
    messagingSenderId: "990604244114",
    appId: "1:990604244114:web:9310948c26ecb3037b224b",
    measurementId: "G-L862VHWGXV"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth();
const storage = getStorage();
const db = getFirestore();
const provider = new GoogleAuthProvider();

// حالة التطبيق
let currentUser = null;
let userRole = null;
let selectedAppImages = [];
let currentAppDetails = null;

// عناصر DOM
const welcomeScreen = document.getElementById('welcomeScreen');
const developerAuth = document.getElementById('developerAuth');
const userAuth = document.getElementById('userAuth');
const developerDashboard = document.getElementById('developerDashboard');
const userDashboard = document.getElementById('userDashboard');
const appDetails = document.getElementById('appDetails');

// استمع لتغير حالة المصادقة
onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
        // تحميل بيانات المستخدم من Firestore
        loadUserData(user.uid);
    } else {
        showScreen('welcomeScreen');
    }
});

// اختيار الدور
function selectRole(role) {
    userRole = role;
    if (role === 'developer') {
        showScreen('developerAuth');
    } else {
        showScreen('userAuth');
    }
}

// تسجيل المطور
document.getElementById('devRegisterBtn').addEventListener('click', async () => {
    const name = document.getElementById('devName').value;
    const email = document.getElementById('devEmail').value;
    const password = document.getElementById('devPassword').value;
    
    if (!name || !email || !password) {
        showMessage('devAuthMsg', 'يرجى ملء جميع الحقول', 'danger');
        return;
    }
    
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: name });
        
        // حفظ بيانات المطور في Firestore
        await addDoc(collection(db, 'developers'), {
            uid: userCredential.user.uid,
            name: name,
            email: email,
            role: 'developer',
            createdAt: new Date()
        });
        
        showMessage('devAuthMsg', 'تم إنشاء حساب المطور بنجاح!', 'success');
        setTimeout(() => {
            showDeveloperDashboard(userCredential.user);
        }, 1500);
        
    } catch (error) {
        handleAuthError(error, 'devAuthMsg');
    }
});

// تسجيل المستخدم
document.getElementById('userRegisterBtn').addEventListener('click', async () => {
    const name = document.getElementById('userName').value;
    const email = document.getElementById('userEmail').value;
    const password = document.getElementById('userPassword').value;
    
    if (!name || !email || !password) {
        showMessage('userAuthMsg', 'يرجى ملء جميع الحقول', 'danger');
        return;
    }
    
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName: name });
        
        // حفظ بيانات المستخدم في Firestore
        await addDoc(collection(db, 'users'), {
            uid: userCredential.user.uid,
            name: name,
            email: email,
            role: 'user',
            createdAt: new Date()
        });
        
        showMessage('userAuthMsg', 'تم إنشاء حساب المستخدم بنجاح!', 'success');
        setTimeout(() => {
            showUserDashboard(userCredential.user);
        }, 1500);
        
    } catch (error) {
        handleAuthError(error, 'userAuthMsg');
    }
});

// تحميل بيانات المستخدم
async function loadUserData(uid) {
    try {
        // تحقق من دور المطور
        const devQuery = query(collection(db, 'developers'), where('uid', '==', uid));
        const devSnapshot = await getDocs(devQuery);
        
        if (!devSnapshot.empty) {
            showDeveloperDashboard(currentUser);
            return;
        }
        
        // تحقق من دور المستخدم
        const userQuery = query(collection(db, 'users'), where('uid', '==', uid));
        const userSnapshot = await getDocs(userQuery);
        
        if (!userSnapshot.empty) {
            showUserDashboard(currentUser);
            return;
        }
        
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}

// عرض لوحة المطور
function showDeveloperDashboard(user) {
    showScreen('developerDashboard');
    document.getElementById('devAvatar').textContent = (user.displayName || 'M').charAt(0).toUpperCase();
    loadDeveloperApps();
    setupAppUpload();
}

// عرض لوحة المستخدم
function showUserDashboard(user) {
    showScreen('userDashboard');
    document.getElementById('userAvatar').textContent = (user.displayName || 'U').charAt(0).toUpperCase();
    loadAllApps();
    setupSearch();
}

// إعداد رفع التطبيق
function setupAppUpload() {
    const appImagesInput = document.getElementById('appImages');
    const imagePreview = document.getElementById('imagePreview');
    const publishBtn = document.getElementById('publishAppBtn');
    
    // معاينة الصور
    appImagesInput.addEventListener('change', (e) => {
        selectedAppImages = Array.from(e.target.files);
        imagePreview.innerHTML = '';
        
        selectedAppImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button type="button" class="remove-image" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                imagePreview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
    });
    
    // نشر التطبيق
    publishBtn.addEventListener('click', async () => {
        const appName = document.getElementById('appName').value;
        const appDescription = document.getElementById('appDescription').value;
        const appFile = document.getElementById('appFile').files[0];
        
        if (!appName || !appDescription || !appFile) {
            showMessage('uploadMsg', 'يرجى ملء جميع الحقول ورفع الملف', 'danger');
            return;
        }
        
        if (selectedAppImages.length === 0) {
            showMessage('uploadMsg', 'يرجى رفع صور للتطبيق', 'danger');
            return;
        }
        
        await publishApp(appName, appDescription, appFile, selectedAppImages);
    });
}

// نشر التطبيق
async function publishApp(name, description, appFile, images) {
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const uploadMsg = document.getElementById('uploadMsg');
    
    uploadProgress.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';
    
    try {
        // رفع الصور
        const imageUrls = [];
        for (let i = 0; i < images.length; i++) {
            const imageRef = ref(storage, `apps/${currentUser.uid}/images/${Date.now()}_${images[i].name}`);
            const uploadTask = uploadBytesResumable(imageRef, images[i]);
            
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = ((i + snapshot.bytesTransferred / snapshot.totalBytes) / (images.length + 1)) * 100;
                        progressBar.style.width = `${Math.round(progress)}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                    },
                    reject,
                    async () => {
                        const url = await getDownloadURL(uploadTask.snapshot.ref);
                        imageUrls.push(url);
                        resolve();
                    }
                );
            });
        }
        
        // رفع ملف التطبيق
        const appRef = ref(storage, `apps/${currentUser.uid}/files/${Date.now()}_${appFile.name}`);
        const uploadTask = uploadBytesResumable(appRef, appFile);
        
        await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = ((images.length + snapshot.bytesTransferred / snapshot.totalBytes) / (images.length + 1)) * 100;
                    progressBar.style.width = `${Math.round(progress)}%`;
                    progressText.textContent = `${Math.round(progress)}%`;
                },
                reject,
                async () => {
                    const appUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    
                    // حفظ بيانات التطبيق
                    await addDoc(collection(db, 'apps'), {
                        name: name,
                        description: description,
                        fileUrl: appUrl,
                        fileName: appFile.name,
                        fileSize: appFile.size,
                        images: imageUrls,
                        developerId: currentUser.uid,
                        developerName: currentUser.displayName,
                        uploadDate: new Date().toLocaleString('ar-SA'),
                        downloads: 0,
                        type: 'app'
                    });
                    
                    resolve();
                }
            );
        });
        
        showMessage('uploadMsg', 'تم نشر التطبيق بنجاح!', 'success');
        uploadProgress.style.display = 'none';
        
        // إعادة تعيين النموذج
        document.getElementById('appName').value = '';
        document.getElementById('appDescription').value = '';
        document.getElementById('appFile').value = '';
        document.getElementById('appImages').value = '';
        document.getElementById('imagePreview').innerHTML = '';
        selectedAppImages = [];
        
        // إعادة تحميل التطبيقات
        loadDeveloperApps();
        
    } catch (error) {
        console.error('Error publishing app:', error);
        showMessage('uploadMsg', `خطأ في النشر: ${error.message}`, 'danger');
        uploadProgress.style.display = 'none';
    }
}

// تحميل تطبيقات المطور
async function loadDeveloperApps() {
    const appsList = document.getElementById('developerAppsList');
    
    try {
        const q = query(collection(db, 'apps'), where('developerId', '==', currentUser.uid));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            appsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3>لا توجد تطبيقات منشورة بعد</h3>
                    <p>ابدأ بنشر أول تطبيق لك</p>
                </div>
            `;
            return;
        }
        
        appsList.innerHTML = '';
        snapshot.forEach(doc => {
            const app = doc.data();
            const appElement = createAppElement(app, doc.id, true);
            appsList.appendChild(appElement);
        });
        
    } catch (error) {
        console.error('Error loading developer apps:', error);
    }
}

// تحميل جميع التطبيقات
async function loadAllApps() {
    const appsGrid = document.getElementById('appsGrid');
    
    try {
        const q = query(collection(db, 'apps'), orderBy('uploadDate', 'desc'));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            appsGrid.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <h3>لا توجد تطبيقات متاحة حالياً</h3>
                    <p>كن أول من ينشر تطبيق!</p>
                </div>
            `;
            return;
        }
        
        appsGrid.innerHTML = '';
        snapshot.forEach(doc => {
            const app = doc.data();
            const appElement = createAppElement(app, doc.id, false);
            appsGrid.appendChild(appElement);
        });
        
    } catch (error) {
        console.error('Error loading apps:', error);
    }
}

// إنشاء عنصر التطبيق
function createAppElement(app, appId, isDeveloper) {
    const appCard = document.createElement('div');
    appCard.className = 'app-card';
    appCard.onclick = () => showAppDetails(app, appId);
    
    const firstImage = app.images && app.images.length > 0 ? app.images[0] : null;
    
    appCard.innerHTML = `
        <div class="app-image" style="${firstImage ? `background-image: url('${firstImage}'); background-size: cover;` : ''}">
            ${!firstImage ? '<i class="fas fa-mobile-alt"></i>' : ''}
        </div>
        <div class="app-info">
            <div class="app-name">${app.name}</div>
            <div class="app-developer">بواسطة: ${app.developerName}</div>
            <div class="app-description">${app.description}</div>
            <div class="app-meta">
                <span><i class="fas fa-download"></i> ${app.downloads || 0}</span>
                <span><i class="far fa-calendar"></i> ${app.uploadDate}</span>
            </div>
        </div>
    `;
    
    return appCard;
}

// عرض تفاصيل التطبيق
function showAppDetails(app, appId) {
    currentAppDetails = { ...app, id: appId };
    showScreen('appDetails');
    
    const appDetailsContent = document.getElementById('appDetailsContent');
    const screenshotsHtml = app.images ? app.images.map(img => `
        <div class="screenshot" style="background-image: url('${img}'); background-size: cover;"></div>
    `).join('') : '';
    
    appDetailsContent.innerHTML = `
        <div class="app-details">
            <div class="app-hero" style="${app.images && app.images[0] ? `background-image: url('${app.images[0]}'); background-size: cover;` : ''}">
                <div class="app-hero-content">
                    ${!app.images || !app.images[0] ? '<div class="app-hero-icon"><i class="fas fa-mobile-alt"></i></div>' : ''}
                    <div class="app-hero-name">${app.name}</div>
                    <div class="app-hero-developer">بواسطة: ${app.developerName}</div>
                </div>
            </div>
            
            <div class="app-content">
                <h3>عن التطبيق</h3>
                <p>${app.description}</p>
                
                ${app.images && app.images.length > 1 ? `
                <h3>الصور</h3>
                <div class="app-screenshots">
                    ${screenshotsHtml}
                </div>
                ` : ''}
                
                <div class="download-section">
                    <h3>تحميل التطبيق</h3>
                    <p>حجم الملف: ${formatFileSize(app.fileSize)}</p>
                    <button class="btn btn-success download-btn" onclick="downloadApp('${app.fileUrl}', '${app.fileName}', '${appId}')">
                        <i class="fas fa-download"></i> تحميل الآن
                    </button>
                </div>
            </div>
        </div>
    `;
}

// تحميل التطبيق
async function downloadApp(fileUrl, fileName, appId) {
    try {
        // زيادة عداد التحميلات
        const appRef = doc(db, 'apps', appId);
        const currentDownloads = currentAppDetails.downloads || 0;
        await updateDoc(appRef, {
            downloads: currentDownloads + 1,
            lastDownload: new Date().toISOString()
        });
        
        // بدء التحميل
        const link = document.createElement('a');
        link.href = fileUrl;
        link.download = fileName;
        link.click();
        
    } catch (error) {
        console.error('Error downloading app:', error);
    }
}

// البحث
function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const appCards = document.querySelectorAll('.app-card');
        
        appCards.forEach(card => {
            const appName = card.querySelector('.app-name').textContent.toLowerCase();
            const appDescription = card.querySelector('.app-description').textContent.toLowerCase();
            
            if (appName.includes(searchTerm) || appDescription.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
}

// الدوال المساعدة
function showScreen(screenName) {
    const screens = ['welcomeScreen', 'developerAuth', 'userAuth', 'developerDashboard', 'userDashboard', 'appDetails'];
    screens.forEach(screen => {
        document.getElementById(screen).style.display = 'none';
    });
    document.getElementById(screenName).style.display = 'block';
}

function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = `alert alert-${type}`;
    element.style.display = 'block';
    
    if (type === 'success') {
        setTimeout(() => {
            element.style.display = 'none';
        }, 3000);
    }
}

function handleAuthError(error, messageElementId) {
    let errorMessage = 'حدث خطأ أثناء العملية';
    
    switch (error.code) {
        case 'auth/email-already-in-use':
            errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
            break;
        case 'auth/invalid-email':
            errorMessage = 'البريد الإلكتروني غير صحيح';
            break;
        case 'auth/weak-password':
            errorMessage = 'كلمة المرور ضعيفة جداً';
            break;
        default:
            errorMessage = error.message;
    }
    
    showMessage(messageElementId, errorMessage, 'danger');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeImage(index) {
    selectedAppImages.splice(index, 1);
    document.getElementById('appImages').value = '';
    document.getElementById('imagePreview').innerHTML = '';
    
    // إعادة معاينة الصور المتبقية
    selectedAppImages.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-image" onclick="removeImage(${idx})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.getElementById('imagePreview').appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    });
}

function goBack() {
    if (userRole === 'developer') {
        showScreen('developerDashboard');
    } else {
        showScreen('userDashboard');
    }
}

async function logout() {
    try {
        await signOut(auth);
        showScreen('welcomeScreen');
        userRole = null;
        currentAppDetails = null;
        selectedAppImages = [];
    } catch (error) {
        console.error('Error signing out:', error);
    }
}

// جعل الدوال متاحة عالمياً
window.selectRole = selectRole;
window.showDeveloperLogin = () => { /* يمكن إضافة منطق تسجيل الدخول */ };
window.showUserLogin = () => { /* يمكن إضافة منطق تسجيل الدخول */ };
window.removeImage = removeImage;
window.downloadApp = downloadApp;
window.goBack = goBack;
window.logout = logout;
</script>
</body>
</html>
